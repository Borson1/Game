import React, { useState, useEffect, useRef } from 'react';
import { Trophy, Heart, Play, ShoppingBag, ArrowLeft, Coins, Rocket } from 'lucide-react';

const App = () => {
  // --- গেম স্টেট ---
  const [view, setView] = useState('HOME');
  const [score, setScore] = useState(0);
  const [highScore, setHighScore] = useState(parseInt(localStorage.getItem('spaceHighScore')) || 0);
  const [coins, setCoins] = useState(parseInt(localStorage.getItem('spaceCoins')) || 0);
  const [lives, setLives] = useState(3);
  
  const [selectedShipIndex, setSelectedShipIndex] = useState(0);
  const ships = [
    { id: 0, name: 'Scout X', color: '#3b82f6', price: 0, speed: 8, bulletSpeed: 12 },
    { id: 1, name: 'Vanguard', color: '#8b5cf6', price: 500, speed: 10, bulletSpeed: 15 },
    { id: 2, name: 'Destroyer', color: '#ef4444', price: 1500, speed: 12, bulletSpeed: 18 },
  ];
  const [unlockedShips, setUnlockedShips] = useState(JSON.parse(localStorage.getItem('unlockedShips')) || [0]);

  const canvasRef = useRef(null);
  const gameRef = useRef({
    player: { x: 0, y: 0, radius: 18 },
    bullets: [], enemies: [], stars: [], keys: {}, animationId: null, frameCount: 0
  });

  // --- ক্যানভাস সাইজ ঠিক করা (Fix for ship position) ---
  const initCanvas = () => {
    const canvas = canvasRef.current;
    if (canvas) {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      gameRef.current.player.x = canvas.width / 2;
      gameRef.current.player.y = canvas.height - 100;
    }
  };

  useEffect(() => {
    initCanvas();
    window.addEventListener('resize', initCanvas);
    return () => window.removeEventListener('resize', initCanvas);
  }, []);

  const startGame = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const ship = ships[selectedShipIndex];
    gameRef.current = {
      ...gameRef.current,
      player: { x: canvas.width / 2, y: canvas.height - 100, radius: 18, ...ship },
      bullets: [], enemies: [], frameCount: 0,
      stars: Array.from({ length: 100 }, () => ({
        x: Math.random() * canvas.width, y: Math.random() * canvas.height,
        size: Math.random() * 2, speed: Math.random() * 5 + 2
      }))
    };
    
    setScore(0);
    setLives(3);
    setView('PLAYING');
  };

  const update = () => {
    if (view !== 'PLAYING') return;
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const g = gameRef.current;

    // ১. ব্যাকগ্রাউন্ড ক্লিন করা
    ctx.fillStyle = '#020617';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // ২. স্টার মুভমেন্ট
    ctx.fillStyle = 'white';
    g.stars.forEach(s => {
      s.y += s.speed;
      if (s.y > canvas.height) s.y = 0;
      ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill();
    });

    // ৩. প্লেয়ার মুভমেন্ট
    if (g.keys['ArrowLeft'] && g.player.x > 30) g.player.x -= g.player.speed;
    if (g.keys['ArrowRight'] && g.player.x < canvas.width - 30) g.player.x += g.player.speed;

    // ৪. প্লেয়ার ড্রয়িং
    ctx.save();
    ctx.shadowBlur = 15; ctx.shadowColor = g.player.color;
    ctx.fillStyle = g.player.color;
    ctx.beginPath();
    ctx.moveTo(g.player.x, g.player.y - 25);
    ctx.lineTo(g.player.x - 20, g.player.y + 15);
    ctx.lineTo(g.player.x + 20, g.player.y + 15);
    ctx.fill();
    ctx.restore();

    // ৫. অটো শ্যুটিং
    g.frameCount++;
    if (g.frameCount % 15 === 0) {
      g.bullets.push({ x: g.player.x, y: g.player.y - 20, speed: g.player.bulletSpeed });
    }

    // ৬. বুলেট আপডেট
    g.bullets.forEach((b, i) => {
      b.y -= b.speed;
      ctx.fillStyle = '#fff';
      ctx.fillRect(b.x - 2, b.y, 4, 12);
      if (b.y < 0) g.bullets.splice(i, 1);
    });

    // ৭. এনিমি আপডেট
    if (g.frameCount % 60 === 0) {
      g.enemies.push({
        x: Math.random() * (canvas.width - 60) + 30, y: -50,
        radius: 20, speed: 3 + (score / 1000)
      });
    }

    g.enemies.forEach((e, i) => {
      e.y += e.speed;
      ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2;
      ctx.strokeRect(e.x - 15, e.y - 15, 30, 30);

      // কলিশন (ধাক্কা লাগা)
      if (Math.hypot(g.player.x - e.x, g.player.y - e.y) < 35) {
        setLives(l => {
          if (l <= 1) { setView('HOME'); return 3; }
          return l - 1;
        });
        g.enemies.splice(i, 1);
      }

      // বুলেটের সাথে কলিশন
      g.bullets.forEach((b, bi) => {
        if (Math.hypot(b.x - e.x, b.y - e.y) < 25) {
          setScore(s => s + 10);
          setCoins(c => c + 1);
          g.enemies.splice(i, 1);
          g.bullets.splice(bi, 1);
        }
      });
      if (e.y > canvas.height) g.enemies.splice(i, 1);
    });

    g.animationId = requestAnimationFrame(update);
  };

  useEffect(() => {
    if (view === 'PLAYING') {
      gameRef.current.animationId = requestAnimationFrame(update);
      const handleDown = (e) => gameRef.current.keys[e.code] = true;
      const handleUp = (e) => gameRef.current.keys[e.code] = false;
      window.addEventListener('keydown', handleDown);
      window.addEventListener('keyup', handleUp);
      return () => {
        cancelAnimationFrame(gameRef.current.animationId);
        window.removeEventListener('keydown', handleDown);
        window.removeEventListener('keyup', handleUp);
      };
    }
  }, [view]);

  return (
    <div className="w-full h-screen bg-black text-white relative font-sans overflow-hidden">
      <canvas ref={canvasRef} className="absolute inset-0" />

      {/* --- HOME UI --- */}
      {view === 'HOME' && (
        <div className="absolute inset-0 flex flex-col items-center justify-center bg-black/40 backdrop-blur-md">
          <div className="p-10 bg-white/5 border border-white/10 rounded-[3rem] text-center mb-8 shadow-2xl">
            <Rocket size={60} className="mx-auto text-blue-500 mb-4 animate-bounce" />
            <h1 className="text-5xl font-black tracking-tighter">SPACE ULTRA</h1>
            <p className="text-gray-400 text-xs tracking-widest uppercase mt-2 font-bold">Glass Edition</p>
          </div>
          
          <div className="flex gap-4 mb-10">
            <div className="bg-white/10 px-6 py-4 rounded-2xl border border-white/10 text-center">
              <p className="text-[10px] text-gray-500 font-bold uppercase">Best</p>
              <p className="text-2xl font-black">{highScore}</p>
            </div>
            <div className="bg-white/10 px-6 py-4 rounded-2xl border border-white/10 text-center">
              <p className="text-[10px] text-gray-500 font-bold uppercase">Coins</p>
              <p className="text-2xl font-black text-amber-400 flex items-center gap-2"><Coins size={18}/> {coins}</p>
            </div>
          </div>

          <button onClick={startGame} className="w-64 py-5 bg-blue-600 rounded-2xl font-black text-xl hover:bg-blue-500 transition-all active:scale-95 shadow-lg shadow-blue-500/20">
            START GAME
          </button>
        </div>
      )}

      {/* --- HUD --- */}
      {view === 'PLAYING' && (
        <div className="absolute top-0 left-0 w-full p-6 flex justify-between items-center pointer-events-none">
          <div className="bg-white/10 backdrop-blur-md border border-white/20 px-6 py-3 rounded-2xl">
            <p className="text-[10px] font-bold text-blue-400 uppercase">Score</p>
            <p className="text-3xl font-black">{score}</p>
          </div>
          <div className="flex gap-2 bg-white/10 backdrop-blur-md border border-white/20 px-6 py-4 rounded-2xl">
            {[...Array(3)].map((_, i) => (
              <Heart key={i} size={24} fill={i < lives ? "#f43f5e" : "none"} className={i < lives ? "text-rose-500" : "text-white/20"} />
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
                
